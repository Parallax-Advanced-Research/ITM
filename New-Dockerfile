# syntax=docker/dockerfile:latest
FROM python:3.10 AS prod

WORKDIR /root

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt/lists,sharing=locked \
    --mount=type=cache,target=/root/.cache/pip \
    --mount=type=bind,source=requirements.txt,target=/root/tad/requirements.txt \
<<EOF
wget https://beta.quicklisp.org/quicklisp.lisp
apt-get update
apt-get install -y sbcl git
yes "" | sbcl --load quicklisp.lisp --eval "(progn (quicklisp-quickstart:install) (eval (read-from-string \"(quicklisp:add-to-init-file)\")) (quit))" 
rm quicklisp.lisp
git clone https://github.com/NextCenturyCorporation/itm-evaluation-client.git

git clone https://github.com/dmenager/HEMS.git /root/quicklisp/local-projects/HEMS
cp "/root/quicklisp/local-projects/HEMS/examples/Common Lisp/example.lisp" /root/quicklisp/local-projects/

pip install -r /root/tad/requirements.txt
pip install -e /root/itm-evaluation-client
EOF

WORKDIR /root/tad

ADD components/decision_analyzer/event_based_diagnosis/hems-package-replacement.lisp /root/quicklisp/local-projects/HEMS/package.lisp
ADD components/ /root/tad/components
ADD data/ /root/tad/data
ADD domain/ /root/tad/domain
ADD runner/ /root/tad/runner
ADD scripts/ /root/tad/scripts
ADD temp/ /root/tad/temp
ADD util/ /root/tad/util
ADD tad.py /root/tad

# ------

FROM prod as ci

RUN --mount=type=cache,target=/root/.cache/pip \
<<EOF
pip install pytest ruff

EOF